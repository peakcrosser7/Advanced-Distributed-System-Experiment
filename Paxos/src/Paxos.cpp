#include <stdlib.h>
#include <stdio.h>
#include "Paxos/Acceptor.h"
#include "Paxos/Proposer.h"
#include "lib/Thread.h"
#include "lib/Lock.h"
#include "lib/mapi.h"
#include "lib/atom.h"
#include "lib/Logger.h"

paxos::Proposer p[5];
paxos::Acceptor a[11];
mdk::Mutex l[11];
int finishedCount = 0;
int finalValue = -1;
bool isFinished = false;
mdk::uint64 g_start;
mdk::Logger g_log;

void* Proposer(void *id)
{
	mdk::Logger log;
	char logName[256];
	sprintf( logName, "Proposer%d", (long)id );
	log.SetLogName(logName);
	log.SetMaxLogSize(10);
	log.SetMaxExistDay(30);
	log.SetPrintLog(false);

	paxos::Proposer &proposer = p[(long)id];
	paxos::PROPOSAL value = proposer.GetProposal();
	paxos::PROPOSAL lastValue;


	int acceptorId[11];
	int count = 0;

	mdk::uint64 start = mdk::MillTime();
	while ( true )
	{
		value = proposer.GetProposal();//???????
		log.Info("Info", "Proposer%d????(Propose???):????=[???:%d??????:%d]\n", 
			(long)id, value.serialNum, value.value);
		count = 0;
		int i = 0;
		for (i = 0; i < 11; i++ )
		{
		/*
			* ???????????i??acceptor
			* ???????????acceptor??sleep(??????)???
			* acceptor?????????mAcceptors[i].Propose()
			* ???proposer
			* ??????????proposer????????sleep(??????)???
			* proposer???????mProposer.proposed(ok, lastValue)
		*/
			mdk::m_sleep(rand()%500);//???????????????????mAcceptors[i]
			//???????
			l[i].Lock();
			bool ok = a[i].Propose(value.serialNum, lastValue);
			l[i].Unlock();
			mdk::m_sleep(rand()%500);//??????????,???????Proposer
			//????Propose???
			if ( !proposer.Proposed(ok, lastValue) ) //??????Propose???
			{
				mdk::m_sleep(1000);//?????????????????????proposer?§Ý???????????2??????
				break;
			}
			paxos::PROPOSAL curValue = proposer.GetProposal();//???????
			if ( curValue.value != value.value )//acceptor???¦Ë??????????????????
			{
				log.Info("Info", "Proposer%d???????????:????=[???:%d??????:%d]\n", 
					(long)id, curValue.serialNum, curValue.value);
				break;
			}
			acceptorId[count++] = i;//??????????acceptor
			if ( proposer.StartAccept() ) break;
		}
		//???????§Õ?Accept??????????????§Ò?????????Propose???
		if ( !proposer.StartAccept() ) continue;

		//???Accept???
		//????Accept????????????????acceptor
		value = proposer.GetProposal();
		log.Info("Info", "Proposer%d????(Accept???):????=[???:%d??????:%d]\n", 
			(long)id, value.serialNum, value.value);
		for (i = 0; i < count; i++ )
		{
			//????accept?????acceptor
			//????accept??¦Å????????????
			mdk::m_sleep(rand()%200);//??????????,accept???????acceptor
			//????accept???
			l[acceptorId[i]].Lock();
			bool ok = a[acceptorId[i]].Accept(value);
			l[acceptorId[i]].Unlock();
			mdk::m_sleep(rand()%200);//??????????,accept???????proposer
			//????accept???
			if ( !proposer.Accepted(ok) ) //??????Propose???
			{
				mdk::m_sleep(1000);//?????????????????????proposer?§Ý???????????2??????
				break;
			}
			if ( proposer.IsAgree() )//????????????
			{
				start = mdk::MillTime() - start;
				log.Info("Info", "Proposer%d??????÷€???,???%lluMS:???????? = [???:%d??????:%d]\n", (long)id, start, value.serialNum, value.value);
				g_log.Info("Info", "Proposer%d??????÷€???,???%lluMS:???????? = [???:%d??????:%d]\n", (long)id, start, value.serialNum, value.value);
				if(finalValue == -1) finalValue = value.value;
				else if(finalValue != value.value) finalValue = 0;
				if ( 4 == mdk::AtomAdd(&finishedCount, 1) )
				{
					isFinished = true;
					g_start = mdk::MillTime() - g_start;
					if(finalValue > 0){
						g_log.Info("Info", "Paxos???????%lluMS?????????????????%d\n", g_start, finalValue);
					}
					else{
						g_log.Info("Info", "Paxos???????%lluMS??????????????\n", g_start);
					}
				}
				return NULL;
			}
		}
	}
	return NULL;
}

//Paxos??????????????
int main(int argc, char* argv[])
{
	int i = 0;
	g_log.SetLogName("Paxos");
	g_log.SetMaxLogSize(10);
	g_log.SetMaxExistDay(30);
	g_log.SetPrintLog(true);
	g_log.Info("Info", "5??Proposer, 11??Acceptor???????Paxos\n"
		"???Proposer????????Acceptor????????\n"
		"Proposer????0-10,????i??Proposer??????????????????i+1, i+1??\n"
		"Proposer??????????????????????5\n"
		"Proposer?????????????,??????????????????????????????????????\n");
	g_start = mdk::MillTime();
	g_log.Info("Info", "Paxos???\n" );
	paxos::PROPOSAL value;

	for ( i = 0; i < 5; i++ ) 
	{
		p[i].SetPlayerCount(5, 11);
		value.serialNum = value.value = i + 1;
		p[i].StartPropose(value);
	}

	mdk::Thread t[5];
	for ( i = 0; i < 5; i++ ) t[i].Run(Proposer, (void*)i);
	//for ( i = 0; i < 5; i++ ) t[i].WaitStop();
	while(true){
		if(isFinished) break;
		mdk::m_sleep(500);
	}
	return 0;
}
